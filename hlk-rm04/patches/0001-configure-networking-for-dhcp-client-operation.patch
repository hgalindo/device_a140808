From bbec2bf0bed0169e51c40aeabc62e12acb0b5264 Mon Sep 17 00:00:00 2001
From: John Clark <inindev@gmail.com>
Date: Sat, 30 Jan 2016 14:04:51 +0000
Subject: [PATCH 1/3] configure networking for dhcp client operation

Signed-off-by: John Clark <inindev@gmail.com>
---
 package/base-files/files/bin/config_generate       | 12 +++---
 .../linux/ramips/base-files/etc/board.d/02_network | 10 ++++-
 .../lib/preinit/07_set_preinit_iface_ramips        | 48 ----------------------
 target/linux/ramips/dts/HLKRM04.dts                |  2 +-
 4 files changed, 15 insertions(+), 57 deletions(-)
 delete mode 100644 target/linux/ramips/base-files/lib/preinit/07_set_preinit_iface_ramips

diff --git a/package/base-files/files/bin/config_generate b/package/base-files/files/bin/config_generate
index 550de0e..b961751 100755
--- a/package/base-files/files/bin/config_generate
+++ b/package/base-files/files/bin/config_generate
@@ -15,8 +15,8 @@ generate_static_network() {
 		set network.loopback.ipaddr='127.0.0.1'
 		set network.loopback.netmask='255.0.0.0'
 		delete network.globals
-		set network.globals='globals'
-		set network.globals.ula_prefix='auto'
+#		set network.globals='globals'
+#		set network.globals.ula_prefix='auto'
 	EOF
 
 	if json_is_a dsl object; then
@@ -66,10 +66,10 @@ generate_network() {
 
 	[ -n "$ifname" ] || return
 
-	# force bridge for multi-interface devices (and lan)
-	case "$1:$ifname" in
-		*\ * | lan:*) type="bridge" ;;
-	esac
+#	# force bridge for multi-interface devices (and lan)
+#	case "$1:$ifname" in
+#		*\ * | lan:*) type="bridge" ;;
+#	esac
 
 	uci -q batch <<-EOF
 		delete network.$1
diff --git a/target/linux/ramips/base-files/etc/board.d/02_network b/target/linux/ramips/base-files/etc/board.d/02_network
index 0121e51..fb16ab4 100755
--- a/target/linux/ramips/base-files/etc/board.d/02_network
+++ b/target/linux/ramips/base-files/etc/board.d/02_network
@@ -66,7 +66,6 @@ ramips_setup_interfaces()
 	dir-610-a1|\
 	dir-615-h1|\
 	firewrt|\
-	hlk-rm04|\
 	miwifi-mini|\
 	mt7621|\
 	mt7628|\
@@ -167,6 +166,12 @@ ramips_setup_interfaces()
 		ucidef_add_switch "switch0" \
 			"1:lan" "2:lan" "3:lan" "4:lan" "5:lan" "0:wan" "6@eth0"
 		;;
+	hlk-rm04)
+		ucidef_add_switch "switch0"
+		ucidef_add_switch_attr "switch0" "enable" "false"
+		ucidef_set_interface_lan "eth0" "dhcp"
+		ucidef_set_interface_wan "wlan0" "dhcp"
+		;;
 	m2m)
 		ucidef_add_switch "switch0"
 		ucidef_add_switch_attr "switch0" "reset" "false"
@@ -240,7 +245,6 @@ ramips_setup_macs()
 	dir-620-a1|\
 	esr-9753|\
 	freestation5|\
-	hlk-rm04|\
 	mpr-a1|\
 	mpr-a2|\
 	psr-680w|\
@@ -275,6 +279,8 @@ ramips_setup_macs()
 		[ -n "$lan_mac" ] || lan_mac=$(cat /sys/class/net/eth0/address)
 		wan_mac=$(macaddr_add "$lan_mac" 1)
 		;;
+	hlk-rm04)
+		;;
 	ht-tm02)
 		lan_mac=$(cat /sys/class/net/eth0/address)
 		;;
diff --git a/target/linux/ramips/base-files/lib/preinit/07_set_preinit_iface_ramips b/target/linux/ramips/base-files/lib/preinit/07_set_preinit_iface_ramips
deleted file mode 100644
index 6948851..0000000
--- a/target/linux/ramips/base-files/lib/preinit/07_set_preinit_iface_ramips
+++ /dev/null
@@ -1,48 +0,0 @@
-#!/bin/sh
-#
-# Copyright (C) 2013 OpenWrt.org
-#
-
-. /lib/ramips.sh
-
-ramips_set_preinit_iface() {
-	RT3X5X=`cat /proc/cpuinfo | egrep "(RT3.5|RT5350|MT7628|MT7688)"`
-	MT762X=`cat /proc/cpuinfo | egrep "MT7620"`
-
-	if [ -n "${RT3X5X}" ]; then
-		swconfig dev rt305x set reset 1
-	elif [ -n "${MT762X}" ]; then
-		# The mt7530 switch driver enables VLAN by default, but
-		# failsafe uses eth0, making the device unreachable:
-		# https://dev.openwrt.org/ticket/18768
-		case "${MT762X}" in
-		*MT7620*)
-			mt762x_switchdev=mt7620
-			;;
-		esac
-		swconfig dev $mt762x_switchdev set reset 1
-		swconfig dev $mt762x_switchdev set enable_vlan 0
-		swconfig dev $mt762x_switchdev set apply 1
-	fi
-
-	if echo $RT3X5X | egrep -q "(RT5350|MT7628|MT7688)"; then
-		# This is a dirty hack to get by while the switch
-		# problem is investigated. When VLAN is disabled, ICMP
-		# pings work as expected, but TCP connections time
-		# out, so telnetting in failsafe is impossible. The
-		# likely reason is TCP checksumming hardware getting
-		# disabled:
-		# https://www.mail-archive.com/openwrt-devel@lists.openwrt.org/msg19870.html
-		swconfig dev rt305x set enable_vlan 1
-		swconfig dev rt305x vlan 1 set ports "0 6"
-		swconfig dev rt305x port 6 set untag 0
-		swconfig dev rt305x set apply 1
-		ip link add link eth0 name eth0.1 type vlan id 1
-		ip link set eth0 up
-		ifname=eth0.1
-	else
-		ifname=eth0
-	fi
-}
-
-boot_hook_add preinit_main ramips_set_preinit_iface
diff --git a/target/linux/ramips/dts/HLKRM04.dts b/target/linux/ramips/dts/HLKRM04.dts
index 3c9a93c..7b27854 100644
--- a/target/linux/ramips/dts/HLKRM04.dts
+++ b/target/linux/ramips/dts/HLKRM04.dts
@@ -72,7 +72,7 @@
 	};
 
 	ethernet@10100000 {
-		mtd-mac-address = <&factory 0x4>;
+		mtd-mac-address = <&factory 0x28>;
 	};
 
 	wmac@10180000 {
-- 
2.5.0

